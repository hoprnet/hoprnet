tasks:
  ## HOPR net repositories
  - name: Environment setup
    init: |
      echo 'ðŸ¦„ ðŸ“¦ Installing hoprnet repository dependencies'
      ./scripts/install-websocat.sh
      sudo apt -y install tmux
      yarn
      echo 'ðŸ¦„ ðŸ“¦ Building latest version of hoprnet monorepo'
      yarn build

    command: |
      echo 'ðŸŸ¡ Running HOPR nodes and topology'
      ./scripts/setup-local-cluster.sh -t "^^LOCAL-testing-123^^" -m "$(gp url 8080)" -i scripts/topologies/full_interconnected_cluster.sh

    openMode: tab-after

  - name: Command window
    before: |
      gp await-port 13301 && gp await-port 13302 && gp await-port 13303 && gp await-port 13304 && gp await-port 13305 && sleep 15s
    command: |
      export apiToken="^^LOCAL-testing-123^^"
      export HOPR_NODE_1_HTTP_URL=$(gp url 13301) HOPR_NODE_1_WS_URL=$(gp url 19501) 
      export HOPR_NODE_1_ADDR=$(curl -X 'GET' "$HOPR_NODE_1_HTTP_URL/api/v2/account/addresses" -H 'accept: application/json' -H "x-auth-token: $apiToken" 2>/dev/null | jq -r '.hopr')
      export HOPR_NODE_2_HTTP_URL=$(gp url 13302) HOPR_NODE_2_WS_URL=$(gp url 19502)
      export HOPR_NODE_2_ADDR=$(curl -X 'GET' "$HOPR_NODE_2_HTTP_URL/api/v2/account/addresses" -H 'accept: application/json' -H "x-auth-token: $apiToken" 2>/dev/null | jq -r '.hopr')
      export HOPR_NODE_3_HTTP_URL=$(gp url 13303) HOPR_NODE_3_WS_URL=$(gp url 19503)
      export HOPR_NODE_3_ADDR=$(curl -X 'GET' "$HOPR_NODE_3_HTTP_URL/api/v2/account/addresses" -H 'accept: application/json' -H "x-auth-token: $apiToken" 2>/dev/null | jq -r '.hopr')
      export HOPR_NODE_4_HTTP_URL=$(gp url 13304) HOPR_NODE_4_WS_URL=$(gp url 19504)
      export HOPR_NODE_4_ADDR=$(curl -X 'GET' "$HOPR_NODE_4_HTTP_URL/api/v2/account/addresses" -H 'accept: application/json' -H "x-auth-token: $apiToken" 2>/dev/null | jq -r '.hopr')
      export HOPR_NODE_5_HTTP_URL=$(gp url 13305) HOPR_NODE_5_WS_URL=$(gp url 19505)
      export HOPR_NODE_5_ADDR=$(curl -X 'GET' "$HOPR_NODE_5_HTTP_URL/api/v2/account/addresses" -H 'accept: application/json' -H "x-auth-token: $apiToken" 2>/dev/null | jq -r '.hopr')
      echo "ðŸ’» Node 1 address: $HOPR_NODE_1_ADDR"
      echo "ðŸ’» Node 2 address: $HOPR_NODE_2_ADDR"
      echo "ðŸ’» Node 3 address: $HOPR_NODE_3_ADDR"
      echo "ðŸ’» Node 4 address: $HOPR_NODE_4_ADDR"
      echo "ðŸ’» Node 5 address: $HOPR_NODE_5_ADDR"

    openMode: tab-after

  - name: Node 1 WS
    before: |
      gp await-port 13301 && gp await-port 13302 && gp await-port 13303 && gp await-port 13304 && gp await-port 13305 && sleep 15s
    command: |
      export apiToken="^^LOCAL-testing-123^^"
      export HOPR_NODE_1_HTTP_URL=$(gp url 13301) HOPR_NODE_1_WS_URL=$(gp url 19501) 
      export HOPR_NODE_1_ADDR=$(curl -X 'GET' "$HOPR_NODE_1_HTTP_URL/api/v2/account/addresses" -H 'accept: application/json' -H "x-auth-token: $apiToken" 2>/dev/null | jq -r '.hopr')
      export HOPR_NODE_2_HTTP_URL=$(gp url 13302) HOPR_NODE_2_WS_URL=$(gp url 19502)
      export HOPR_NODE_2_ADDR=$(curl -X 'GET' "$HOPR_NODE_2_HTTP_URL/api/v2/account/addresses" -H 'accept: application/json' -H "x-auth-token: $apiToken" 2>/dev/null | jq -r '.hopr')
      export HOPR_NODE_3_HTTP_URL=$(gp url 13303) HOPR_NODE_3_WS_URL=$(gp url 19503)
      export HOPR_NODE_3_ADDR=$(curl -X 'GET' "$HOPR_NODE_3_HTTP_URL/api/v2/account/addresses" -H 'accept: application/json' -H "x-auth-token: $apiToken" 2>/dev/null | jq -r '.hopr')
      export HOPR_NODE_4_HTTP_URL=$(gp url 13304) HOPR_NODE_4_WS_URL=$(gp url 19504)
      export HOPR_NODE_4_ADDR=$(curl -X 'GET' "$HOPR_NODE_4_HTTP_URL/api/v2/account/addresses" -H 'accept: application/json' -H "x-auth-token: $apiToken" 2>/dev/null | jq -r '.hopr')
      export HOPR_NODE_5_HTTP_URL=$(gp url 13305) HOPR_NODE_5_WS_URL=$(gp url 19505)
      export HOPR_NODE_5_ADDR=$(curl -X 'GET' "$HOPR_NODE_5_HTTP_URL/api/v2/account/addresses" -H 'accept: application/json' -H "x-auth-token: $apiToken" 2>/dev/null | jq -r '.hopr')
      echo 'ðŸ“¡ Node 1 WS Connection'
      echo -e "\n"
      sleep 5s
      ./.bin/websocat "$(echo "$HOPR_NODE_1_WS_URL" | sed "s/http/ws/")/?apiToken=$apiToken"

    openMode: tab-after

  - name: Node 2 WS
    before: |
      gp await-port 13301 && gp await-port 13302 && gp await-port 13303 && gp await-port 13304 && gp await-port 13305 && sleep 15s
    command: |
      export apiToken="^^LOCAL-testing-123^^"
      export HOPR_NODE_1_HTTP_URL=$(gp url 13301) HOPR_NODE_1_WS_URL=$(gp url 19501) 
      export HOPR_NODE_1_ADDR=$(curl -X 'GET' "$HOPR_NODE_1_HTTP_URL/api/v2/account/addresses" -H 'accept: application/json' -H "x-auth-token: $apiToken" 2>/dev/null | jq -r '.hopr')
      export HOPR_NODE_2_HTTP_URL=$(gp url 13302) HOPR_NODE_2_WS_URL=$(gp url 19502)
      export HOPR_NODE_2_ADDR=$(curl -X 'GET' "$HOPR_NODE_2_HTTP_URL/api/v2/account/addresses" -H 'accept: application/json' -H "x-auth-token: $apiToken" 2>/dev/null | jq -r '.hopr')
      export HOPR_NODE_3_HTTP_URL=$(gp url 13303) HOPR_NODE_3_WS_URL=$(gp url 19503)
      export HOPR_NODE_3_ADDR=$(curl -X 'GET' "$HOPR_NODE_3_HTTP_URL/api/v2/account/addresses" -H 'accept: application/json' -H "x-auth-token: $apiToken" 2>/dev/null | jq -r '.hopr')
      export HOPR_NODE_4_HTTP_URL=$(gp url 13304) HOPR_NODE_4_WS_URL=$(gp url 19504)
      export HOPR_NODE_4_ADDR=$(curl -X 'GET' "$HOPR_NODE_4_HTTP_URL/api/v2/account/addresses" -H 'accept: application/json' -H "x-auth-token: $apiToken" 2>/dev/null | jq -r '.hopr')
      export HOPR_NODE_5_HTTP_URL=$(gp url 13305) HOPR_NODE_5_WS_URL=$(gp url 19505)
      export HOPR_NODE_5_ADDR=$(curl -X 'GET' "$HOPR_NODE_5_HTTP_URL/api/v2/account/addresses" -H 'accept: application/json' -H "x-auth-token: $apiToken" 2>/dev/null | jq -r '.hopr')
      echo 'ðŸ“¡ Node 2 WS Connection'
      echo -e "\n"
      sleep 5s
      ./.bin/websocat "$(echo "$HOPR_NODE_2_WS_URL" | sed "s/http/ws/")/?apiToken=$apiToken"

    openMode: split-right

ports:
  - name: HOPRd REST API
    port: 13301-13305
    visibility: public
  - name: HOPR protocol
    port: 19091-19095
    visibility: public
  - name: HOPRd Admin
    port: 19501-19505
    visibility: public
