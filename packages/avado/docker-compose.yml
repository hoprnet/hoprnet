# NOTE: This cannot be built as is, it must be built using scripts/build-avado.sh
# %AVADO_VERSION%, %TOKEN%, %ENV_ID% and %PROVIDER_URL% will be replaced with actual values
# when built using the above script.
version: '3.4'
services:
  hopr.avado.dnp.dappnode.eth:
    image: 'hopr.avado.dnp.dappnode.eth:%AVADO_VERSION%'
    restart: always
    build:
      context: ./build
      args:
        UPSTREAM_VERSION: '%UPSTREAM_VERSION%'
    deploy:
      resources:
        limits:
          memory: 1G
    # Lines between *_JSON_EXPORT are intentionally also a valid JSON
    # Info: a hoprd node should never consume more than 1GByte of memory
    # DO NOT REMOVE
    # BEGIN_JSON_EXPORT
    #{
    'volumes': ['db:/app/hoprd-db']
    'environment':
      [
        'DEBUG=hopr*',
        'HOPRD_ENVIRONMENT=%ENV_ID%',
        'HOPRD_HOST=0.0.0.0:9091',
        'HOPRD_ANNOUNCE=false',
        'HOPRD_API=true',
        'HOPRD_API_HOST=0.0.0.0',
        'HOPRD_API_PORT=3001',
        'HOPRD_HEALTH_CHECK=true',
        'HOPRD_HEALTH_CHECK_HOST=0.0.0.0',
        'HOPRD_HEALTH_CHECK_PORT=8080',
        'HOPRD_PASSWORD=open-sesame-iTwnsPNg0hpagP+o6T0KOwiH9RQ0',
        'HOPRD_API_TOKEN=%TOKEN%',
        'HOPRD_IDENTITY=/app/hoprd-db/.hopr-identity',
        'HOPRD_DATA=/app/hoprd-db/data-%ENV_ID%',
        'HOPRD_INIT=true',
        'HOPRD_ALLOW_PRIVATE_NODE_CONNECTIONS=false',
        'HOPRD_PROVIDER=%PROVIDER_URL%'
      ]
    'ports': ['3001:3001/tcp', '8080:8080/tcp', '9091:9091/tcp', '9091:9091/udp']
    #}
    # END_JSON_EXPORT
  hopr-admin.avado.dnp.dappnode.eth:
    image: 'gcr.io/hoprassociation/hopr-admin:07aec21b'
    restart: always
    ports:
      - 3000
    deploy:
      resources:
        limits:
          memory: 256M
volumes:
  db: {}
