\setlength{\parindent}{0pt}

\section{Path Selection}
\label{sec:path-selection}

Packets in the HOPR network are sent via multiple \textit{hops} before they are delivered to the final destination. To achieve its privacy properties, it is crucial for nodes in the network to keep the chosen path secret. As relay nodes differ in their ability to forward packets, path choices need to incorporate the nodes' resources and cannot be chosen entirely at random.

Path selection is therefore done in multiple steps: first, there is a preprocessing that assigns each node a score depending on their relative availability and their stake. The stake is then randomized by multiplying with random numbers yielding the final score of the node.

\begin{enumerate}
    \item \textbf{Assign} each node a score depending on availability and stake
    \item \textbf{Randomize} the edge weights of the subgraph
    \item \textbf{Find} a path in the subgraph using a graph traversal algorithm
\end{enumerate}

\subsection{Node score assignment}
\label{sec:path-selection:pre-selection}

The HOPR network is kept open and permissionless, hence it is not foreseen to have any gatekeeper that grants access to the network and maintains a list of active nodes. For that reason, it is necessary for participants of the network to maintain a solid understanding about the network topology to decide \textit{which} nodes they can use to relay their mixnet packets.

The network topology includes two layers: the payment channel graph and the ability of nodes to establish a network connection to each other. Whilst the former one is easily achieved by observing and indexing on-chain interactions, the latter one needs active communication with other nodes to check their availability. Since the network status can change abruptly e.g. due to lack of electricity or unstable network links, the measuring need to be done frequently.

\subsubsection{Node availabilty}

The availability of nodes in the network is estimated by regularly pinging other nodes in the network and listening to ping attempts from other nodes. Receiving a \textit{ping} request or a \textit{pong} response from another node means that a node is available and gladually increases their network score.

If a node does not respond to \textit{ping} attempts, it is considered \textit{temporary} offline and the waiting time to the next \textit{ping} attempt is doubled until it reaches an upper bound and the node is considered dead.

\subsubsection{Payment channel graph}

Incentives for relaying mixnet packages require the existence of an open payment channel that is funded towards the relay node. Hence, it is necessary to be in sync with the latest on-chain state.

\subsubsection{The importance of stake}

Funding a payment channel with HOPR tokens means staking these tokens in the HOPR network. The more tokens a node stakes, the more likely it is chosen as a relayer by other nodes.

\subsubsection{Network quality computation}

Each node is given a score that includes network
Availability measurement and payment channel stake lead to a

\subsection{Randomization}
\label{sec:path-selection:randomization}

Since the previous step is entirely deterministic and potential adversaries can thus deduct the outcome from public information, each node score gets randomized by multplying it with a random number $r_i$.
$$weight(e_i) := score(e_i) * r_i$$

Note that the random numbers are assigned in the beginning and kept until a path is found.

\subsection{Graph traversal}
\label{sec:path-selection:graph-traversal}

The HOPR network uses source-selected routing, hence each node needs to sample the entire path that the mixnet packet is going to take in advance before sending it to the first relayer.

To achieve the aforementioned privacy guarantees, paths should include a minimum number of intermediate nodes and to make all interactions look the same towards an adversary, \textit{most} of the paths should have the same length. Conversely, longer paths lead due to the usage of the SPHINX packet format, see section \ref{sec:sphinx}, to longer packet headers and more computation, and can thus be easily distinguished by an adversary. As a balance between privacy and efficiency, the HOPR network uses a target $pathLength$ of \textit{three} hops.

As a result of the previous pre-selection, the final path sampling can run on disconnected subgraphs that do not lead to a sufficiently long path. Since the algorithm might take too long in these cases to terminate, the number of iterations is limited by ${maxIterations}$. Analogously, nodes that lead to dead ends are excluded from further node expansions.

\begin{algorithm}[H]
    \SetAlgoNoLine
    \DontPrintSemicolon
    $queue \leftarrow \mathbf{new} \ \mathsf{PriorityQueue}_{\textsf{pathWeight}}()$\;
    $queue.addAll(\{ (x,y) \in E \ | \ x = self)$\;
    $deadEnds \leftarrow \emptyset$\;
    $iterations \leftarrow 0$\;
    \;
    \While{$size(queue) > 0 \ \mathsf{and} \ iterations < maxIterations$}{
    $path \leftarrow queue.peek()$\;
    \If{$length(path) = pathLength$}{
        \Return{$current$}
    }
    \;
    $current \leftarrow last(path)$\;
    $open \leftarrow \mathbf{new} \ \mathsf{PriorityQueue}_{\mathsf{edgeWeight}}()$\;

    \ForEach{$ (x,y) \in E$}{
        \If{$x = current \ \mathbf{and} \ y \notin deadEnds \ \mathbf{and} \ y \notin path$}{
            $open.push(y)$\;
        }
    }
    \;
    \uIf{$size(open) = 0$} {
        $queue.pop()$\;
        $deadEnds \leftarrow deadEnds \cup current$\;
    }
    \Else{
        \ForEach{$node \in open$}{
            $queue.push(\ (...path, node) \ )$\;
        }
    }
    \;
    $iterations \leftarrow iterations + 1$\;
    }
    \caption{Path selection}
\end{algorithm}