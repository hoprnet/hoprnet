\section{Cover Traffic}


Cover Traffic, also known as chafing mechanism, generates and randomly injects packets in the network which increases its anonymity set and thus make fake and real traffic seem indistinguishable from one another. The reason why this is necessary is to make it more difficult for an attacker to deploy passive and active attacks to the network like traffic analysis attacks.
Cover traffic also increases the anonymity level of the mix network by making it harder to identify whether a specific sender is communicating with any receiver, this is also known as the sender online unobservability which is explained in the security goals section.
Another reason to why HOPR needs cover traffic from its early stage is to help provide sender-receiver unlinkability (explained in security goals section) which is a property of mixnets but since in the early stage of developement of HOPR project, only few packets will be travelling through the network, it very easy for a GPA to links the sender and receiver of that packet and thus breaks the unlinkability property.
\\~\\ CT (Cover Traffic) nodes are HOPR nodes with a Cover Traffic service enabled, run by the HOPR Organization for the purpose of generating cover traffic. In the future, anyone in the HOPR network will be able to start a CT node when fulfilling the requirements needed to do so.
\\~\\The problem with cover traffic is that it adds bandwidth overhead in order to increase anonymity which comes the cost of reducing the capacity of the network, as given by the well-known "anonymity trilemma" between capacity, latency, and anonymity. 
\subsection{Opening CT channels:} 
CT nodes must open and fund payment channels before they can send CT packets via that counterparty. The number of channels a CT node can open is predefined and cannot be exceeded. Whenever payment channels are closed, the CT node replaces them by opening new channels as long as it still has funds. 
The channel opening is randomly weighted according to the importance of a node. The importance of a node $\Omega(N)$ is defined as the following:

$$\Omega(N) = st(N) * sum(w(C), \forall \; outgoingChannels(N))$$
where 
$$st(N) = uT(N) + tB(N)$$
And 

$$w(C) = \sqrt{(B(C) / st(Cs) * st(Cd))}$$
\\
Where $N$ is the node, $w$ is the channel's weight, $st$ is its stake $C$ is a payment channel between two nodes in the HOPR network. $Cs$ means the node that opens a payment channel and 
$Cd$ is the destination node of that opened channel. $uT(N)$: The balance of unreleased tokens for a node $N$, $B$ is the channel's balance and $tB$ is the sum of the outgoingBalances of each channel from node $N$.
\\~\\ According to the previous definition, the importance score of a node increases with increasing channel balances of that node towards other nodes with high total stake. This means that channel opening is proportional to a nodeâ€™s stake. CT is allocated in proportion to node's importance and not to channel's stake as a way of protection against selfish node operators who seek to optimize their own profits.
With such a mechanism, the node operator will need to re-allocate their stake to their downstream nodes in order to receive cover traffic. 
The way importance and weight are calculated prevents nodes from opening a few minimally funded channels to large nodes (with huge total stake) and incentivizes nodes to stake in as many possible channels and thus avoids centralization and prevents "Thin Traffic per peer" (creates tiny anonymity set and possible traceability of packets even with high per-hop latency).
\\~\\ We compute the needed cover traffic $\Psi$ as such:
$$\Psi= ( \xi/ (\sigma * P_w)) pk$$
Where $\xi$ is the funds to be distributed, $\sigma$ the ticket amount, $P_w$ is the winning probability and $pk$ is the number of packets.
\\~\\Nodes do not rely on node quality since they are likely to die or lose connectivity. Thus cover traffic distribution is independent from the CT node uptime and instead closes a channel if a mix node is found to be offline a new one is opened which gives a fair chance to nodes which are online more frequently than others. 

\subsection{Path selection and payout}
After opening channels, the CT node sends CT packets at a regular interval. The path selection algorithm used for cover traffic is the same one used to select nodes for real traffic (see path selection section for more details) where nodes are selected at random  but weighted in proportion to the importance of each node starting at the CT node.
The first relay node is chosen with a probability proportional to the amount which the CT node funded so every node has equal chances of getting selected. For the next intermediate hops, nodes are selected with a probability weighted proportional to their importance. We use a weighted priority queue of potential paths to choose the next node, if queue is empty then it fails.
\\Nodes get chosen only once in a path, if we take the following example:
\\For a path $A\rightarrow B$, when looking for the third node in the path, if $A$ is found to be the only node with open channel with $B$ the search will fail and a new path is generated again.
\\~\\ Rewards are distributed in HOPR tokens to all selected nodes in a path as tickets which they can redeem afterwards (see ticket section) here is a correlation between list importance and list 
rewards and thus rewards are distributed fairly.


\subsection{Closing CT channels:}
Channels get closed and others get opened if the following factors is below its threshold:
  \begin{itemize}
      \item \textbf{Channel balance} is less than the minimum stake before closure:
      $$B(C) < L * \sigma$$
      where $B(C)$ is the channel balance, $L$ is the path length and $\sigma$ is the ticket amount which is hardcoded as 0.1 HOPR per ticket.
      \item \textbf{Quality of connections}
      $$q < 0.15$$ $q$-factor is defined as the fraction of `pings` that the node responded to within a 5 second timeout
      \item \textbf{Number of failed packets} is higher than the message fail threshold:
      $$ $$
  \end{itemize}
The CT node calls \textit{initiateChannelClosure()} if the above verifies and emits two events \textit{ChannelUpdate} and \textit{ChannelClosureInitiated}
