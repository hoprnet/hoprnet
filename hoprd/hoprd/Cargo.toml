[package]
name = "hoprd"
version = "4.0.0"
authors = ["HOPR Association <tech@hoprnet.org>"]
edition = "2021"
description = "HOPR node executable"
homepage = "https://hoprnet.org/"
repository = "https://github.com/hoprnet/hoprnet"
license = "GPL-3.0-only"
build = "build.rs"

[features]
default = [
  "runtime-tokio",
  "prometheus",
  "telemetry",
  "explicit-path",
  "transport-quic",
] # uses tokio by default because of axum
prometheus = [
  "hopr-lib/prometheus",
  "hoprd-api/prometheus",
  "hopr-db-node/prometheus",
  "hopr-strategy/prometheus",
  "dep:hopr-metrics",
]
runtime-tokio = [
  "dep:tokio",
  "dep:tokio-retry",
  "hopr-lib/runtime-tokio",
  "hopr-db-node/runtime-tokio",
  "opentelemetry_sdk?/rt-tokio",
  "hopr-strategy/runtime-tokio",
]
telemetry = [
  "dep:opentelemetry",
  "dep:opentelemetry-otlp",
  "dep:opentelemetry_sdk",
  "dep:tracing-opentelemetry",
]
transport-quic = [
  "hopr-lib/transport-announce-quic",
  "hopr-lib/transport-use-quic",
]
explicit-path = ["hoprd-api/explicit-path"]
capture = ["hopr-lib/capture"]
# To use profiling:
# 1. Set RUSTFLAGS="--cfg tokio_unstable" before building
# 2. Enable the 'prof' feature: cargo build --feature prof
prof = [
  "dep:console-subscriber",
] # must be built with 'tokio_unstable': https://github.com/tokio-rs/console/tree/main/console-subscriber

allocator-mimalloc = [
  "dep:mimalloc",
] # Use mimalloc as the global allocator on Linux
allocator-jemalloc = [
  "dep:tikv-jemallocator",
] # Use jemalloc as the global allocator on Linux
allocator-jemalloc-stats = [
  "allocator-jemalloc",
  "dep:tikv-jemalloc-ctl",
  "dep:humansize",
]

[dependencies]
anyhow = { workspace = true }
async-signal = { workspace = true }
async-trait = { workspace = true }
clap = { workspace = true }
console-subscriber = { workspace = true, optional = true }
futures = { workspace = true }
hex = { workspace = true }
home = "0.5.12"
humansize = { workspace = true, optional = true, features = ["no_alloc"] }
humantime-serde = { workspace = true }
proc-macro-regex = { workspace = true }
serde = { workspace = true }
serde_with = { workspace = true }
serde_yaml = { workspace = true }
serde_json = { workspace = true }
signal-hook = { workspace = true }
smart-default = { workspace = true }
strum = { workspace = true }
thiserror = { workspace = true }
tokio = { workspace = true, optional = true }
tokio-retry = { workspace = true, optional = true }
tracing = { workspace = true }
tracing-subscriber = { workspace = true, features = ["fmt", "json"] }
validator = { workspace = true }
opentelemetry = { workspace = true, optional = true }
opentelemetry-otlp = { workspace = true, default-features = false, features = [
  "trace",
  "reqwest-client",
  "tls-roots",
  "http-proto",
  "grpc-tonic",
], optional = true }
lazy_static = { workspace = true }
opentelemetry_sdk = { workspace = true, optional = true }
tracing-opentelemetry = { workspace = true, optional = true }

hopr-strategy = { workspace = true }
hopr-lib = { workspace = true, features = [
  "runtime-tokio",
  "session-client",
  "session-server",
  "utils_parallel",
  "stats",
] }
hopr-ct-telemetry = { workspace = true }
hopr-db-node = { workspace = true }
hopr-chain-connector = { workspace = true }
hopr-utils-session = { workspace = true }
hopr-metrics = { workspace = true, optional = true }
hoprd-api = { workspace = true, features = ["stats"] }

# Target-specific dependencies for memory allocators
[target.'cfg(target_os = "linux")'.dependencies]
mimalloc = { workspace = true, optional = true }
tikv-jemallocator = { workspace = true, optional = true }
tikv-jemalloc-ctl = { workspace = true, features = ["stats"], optional = true }

[build-dependencies]
vergen-gix = { workspace = true, features = ["build"] }
anyhow = { workspace = true }

[dev-dependencies]
tempfile = { workspace = true }
test-log = { workspace = true }
hopr-lib = { workspace = true, features = [
  "runtime-tokio",
  "session-client",
  "session-server",
  "utils_parallel",
  "testing",
] }

[package.metadata.cargo-machete]
ignored = ["humantime-serde"]

[package.metadata.cargo-shear]
ignored = ["humantime-serde"]
