---
#################################################################################
# Main pipeline to build hoprnet artifacts
#################################################################################
name: Build

on:
  merge_group:
    types: [checks_requested]
  pull_request:
    types:
      - synchronize
      - ready_for_review
concurrency:
  group: ${{ github.head_ref }}-build
  cancel-in-progress: true
jobs:
  build-docker-hoprd:
    name: Hoprd
    uses: ./.github/workflows/build-docker.yaml
    with:
      base_branch: ${{ github.event.pull_request.base.ref }}
      package: hoprd
    secrets: inherit

  build-docker-hopli:
    name: Hopli
    if: contains(github.event.pull_request.labels.*.name, 'component:hopli')
    uses: ./.github/workflows/build-docker.yaml
    with:
      base_branch: ${{ github.event.pull_request.base.ref }}
      package: hopli
    secrets: inherit

  build-binary-x86_64-linux:
    name: x86_64-linux
    if: contains(github.event.pull_request.labels.*.name, 'binary:x86_64-linux')
    uses: ./.github/workflows/build-binaries.yaml
    with:
      base_branch: ${{ github.event.pull_request.base.ref }}
      binary_name: hoprd-x86_64-linux
      package: hoprd-x86_64-linux
      runner: self-hosted-hoprnet-big
    secrets: inherit

  build-binary-aarch64-linux:
    name: aarch64-linux
    if: contains(github.event.pull_request.labels.*.name, 'binary:aarch64-linux')
    uses: ./.github/workflows/build-binaries.yaml
    with:
      base_branch: ${{ github.event.pull_request.base.ref }}
      binary_name: hoprd-aarch64-linux
      package: hoprd-aarch64-linux
      runner: self-hosted-hoprnet-big
    secrets: inherit

  build-binary-aarch64-darwin:
    name: aarch64-darwin
    if: contains(github.event.pull_request.labels.*.name, 'binary:aarch64-darwin')
    uses: ./.github/workflows/build-binaries.yaml
    with:
      base_branch: ${{ github.event.pull_request.base.ref }}
      binary_name: hoprd-aarch64-darwin
      runner: macos-14 # M1 machine
    secrets: inherit

  build-binary-x86_64-darwin:
    name: x86_64-darwin
    if: contains(github.event.pull_request.labels.*.name, 'binary:x86_64-darwin')
    uses: ./.github/workflows/build-binaries.yaml
    with:
      base_branch: ${{ github.event.pull_request.base.ref }}
      binary_name: hoprd-x86_64-darwin
      runner: macos-13 # Intel machine
    secrets: inherit

  build-binary-armv7l-linux:
    name: armv7l-linux
    if: contains(github.event.pull_request.labels.*.name, 'binary:armv7l-linux')
    uses: ./.github/workflows/build-binaries.yaml
    with:
      base_branch: ${{ github.event.pull_request.base.ref }}
      system: armv7l-linux
      runner: self-hosted-hoprnet-big
    secrets: inherit

  docs:
    name: Docs
    if: github.event.pull_request.draft == false
    uses: ./.github/workflows/build-docs.yaml
    secrets: inherit
