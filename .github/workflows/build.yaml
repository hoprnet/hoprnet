---
#################################################################################
# Main pipeline to build hoprnet artifacts
#################################################################################
name: Build

on:
  merge_group:
    types: [checks_requested]
  pull_request:
    types:
      - synchronize
      - ready_for_review

concurrency:
  group: ${{ github.head_ref }}-build
  cancel-in-progress: true

jobs:
  build-docker-hoprd:
    name: Hoprd
    uses: ./.github/workflows/build-docker.yaml
    with:
      branch: ${{ github.event.pull_request.head.ref }}
      package: hoprd
    secrets: inherit

  build-docker-hopli:
    name: Hopli
    if: contains(github.event.pull_request.labels.*.name, 'component:hopli')
    uses: ./.github/workflows/build-docker.yaml
    with:
      branch: ${{ github.event.pull_request.head.ref }}
      package: hopli
    secrets: inherit

  build-binary:
    strategy:
      matrix:
        target:
          - name: x86_64-linux
            package: hoprd-x86_64-linux
            runner: self-hosted-hoprnet-big
            interpreter: /lib64/ld-linux-x86-64.so.2
          - name: aarch64-linux
            package: hoprd-aarch64-linux
            runner: self-hosted-hoprnet-big
            interpreter: /lib64/ld-linux-aarch64.so.1
          - name: aarch64-darwin
            package: hoprd
            runner: macos-14 # M1 machine
          - name: x86_64-darwin
            package: hoprd
            runner: macos-13 # Intel machine
          - name: armv7l-linux
            package: hoprd-armv7l-linux
            runner: self-hosted-hoprnet-big
            interpreter: /lib/ld-linux-armhf.so.3
    name: hoprd-${{ matrix.target.name }}
    uses: ./.github/workflows/build-binaries.yaml
    with:
      branch: ${{ github.event.pull_request.head.ref }}
      target: ${{ matrix.target.name }}
      package: ${{ matrix.target.package }}
      runner: ${{ matrix.target.runner }}
    secrets: inherit

  docs:
    name: Docs
    if: github.event.pull_request.draft == false
    uses: ./.github/workflows/build-docs.yaml
    secrets: inherit
