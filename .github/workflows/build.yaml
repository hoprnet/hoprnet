---
#################################################################################
# Main pipeline to build hoprnet
#################################################################################
name: Build

on:
  merge_group:
    types: [checks_requested]
  pull_request:
    types:
      - synchronize
      - ready_for_review
concurrency:
  group: ${{ github.head_ref }}-build
  cancel-in-progress: true
jobs:
  build-docker-hoprd:
    name: Build binary Hoprd docker image
    uses: ./.github/workflows/build-docker.yaml
    with:
      base_branch: ${{ github.event.pull_request.base.ref }}
      package: hoprd
    secrets: inherit

  build-docker-hopli:
    name: Build binary Hopli docker image
    if: contains(github.event.pull_request.labels.*.name, 'component:hopli')
    uses: ./.github/workflows/build-docker.yaml
    with:
      base_branch: ${{ github.event.pull_request.base.ref }}
      package: hopli
    secrets: inherit

  build-binary-x86_64-linux:
    name: Build binary x86_64-linux
    if: contains(github.event.pull_request.labels.*.name, 'binary:x86_64-linux')
    uses: ./.github/workflows/build-binaries.yaml
    with:
      base_branch: ${{ github.event.pull_request.base.ref }}
      system: x86_64-linux
    secrets: inherit

  build-binary-aarch64-linux:
    name: Build binary x86_64-linux
    if: contains(github.event.pull_request.labels.*.name, 'binary:aarch64-linux')
    uses: ./.github/workflows/build-binaries.yaml
    with:
      base_branch: ${{ github.event.pull_request.base.ref }}
      system: aarch64-linux
    secrets: inherit

  build-binary-aarch64-darwin:
    name: Build binary x86_64-linux
    if: contains(github.event.pull_request.labels.*.name, 'binary:aarch64-darwin')
    uses: ./.github/workflows/build-binaries.yaml
    with:
      base_branch: ${{ github.event.pull_request.base.ref }}
      system: aarch64-darwin
    secrets: inherit

  build-binary-x86_64-darwin:
    name: Build binary x86_64-linux
    if: contains(github.event.pull_request.labels.*.name, 'binary:x86_64-darwin')
    uses: ./.github/workflows/build-binaries.yaml
    with:
      base_branch: ${{ github.event.pull_request.base.ref }}
      system: x86_64-darwin
    secrets: inherit

  docs:
    name: Docs
    if: github.event.pull_request.draft == false
    uses: ./.github/workflows/build-docs.yaml
    secrets: inherit
