
---
#################################################################################
# Pipeline to package artifacts
#################################################################################
name: Package

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      target:
        required: true
        type: string

concurrency:
  group: ${{ github.ref }}-package-${{ inputs.target }}
  cancel-in-progress: true

jobs:
  package:
    name: Package binaries
    runs-on: self-hosted-hoprnet-small
    steps:

      - name: Checkout hoprnet repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
          ref: ${{ inputs.branch }}

      # - name: Download hoprd artifacts
      #   uses: actions/download-artifact@v3
      #   with:
      #     name: hoprd-${{ inputs.target }}
      #     path: ./artifacts/hoprd

      # - name: Download hopli artifacts
      #   uses: actions/download-artifact@v3
      #   with:
      #     name: hopli-${{ inputs.target }}
      #     path: ./artifacts/hopli

      - name: Install Nix
        uses: cachix/install-nix-action@17fe5fb4a23ad6cbbe47d6b3f359611ad276644c # v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          nix_path: nixpkgs=channel:nixos-24.05

      - uses: cachix/cachix-action@0fc020193b5a1fa3ac4575aa3a7d3aa6a35435ad # v16
        with:
          name: hoprnet
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
        env:
          USER: runner

      - name: Package binaries
        run: |
          mkdir -p ./artifacts/hoprd ./artifacts/hopli target
          echo "This is a dummy binary" > ./artifacts/hoprd/hoprd
          echo "This is a dummy binary" > ./artifacts/hopli/hopli
          ls -alR ./artifacts
          nix develop -c just package-all {{ matrix.target }}



