
---
#################################################################################
# Pipeline to package artifacts
#################################################################################
name: Package

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      target:
        required: true
        type: string

concurrency:
  group: ${{ github.ref }}-package-${{ inputs.target }}
  cancel-in-progress: true

jobs:
  package:
    runs-on: self-hosted-hoprnet-small
    steps:

      - name: Checkout hoprnet repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
          ref: ${{ inputs.branch }}

      - name: Fetch binaries subworkflow run_id
        run: |
          curl -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/build-binaries.yaml/runs \
            -o runs.json
          run_id=$(jq -r '.workflow_runs[] | select(.head_branch == ${{ github.event.pull_request.head.ref }} and .status == "completed") | .id' runs.json)
          echo "run_id=${run_id}" >> $GITHUB_ENV

          curl -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/${run_id}/artifacts \
            -o artifacts.json

          hoprd_url=$(jq -r '.artifacts[] | select(.name == "hoprd-${{ inputs.target }}").archive_download_url' artifacts.json)
          curl -L -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$hoprd_url" -o hoprd.zip
          unzip hoprd.zip -d ./artifacts

          hopli_url=$(jq -r '.artifacts[] | select(.name == "hopli-${{ inputs.target }}").archive_download_url' artifacts.json)
          curl -L -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$hopli_url" -o hopli.zip
          unzip hopli.zip -d ./artifacts
          ls -alR ./artifacts


      - name: Install Nix
        uses: cachix/install-nix-action@17fe5fb4a23ad6cbbe47d6b3f359611ad276644c # v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          nix_path: nixpkgs=channel:nixos-24.05

      - uses: cachix/cachix-action@0fc020193b5a1fa3ac4575aa3a7d3aa6a35435ad # v16
        with:
          name: hoprnet
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
        env:
          USER: runner

      - name: Package binaries
        run: |
          # set -x
          # mkdir -p ./artifacts/hoprd ./artifacts/hopli target
          # echo "This is a dummy binary" > ./artifacts/hoprd
          # echo "This is a dummy binary" > ./artifacts/hopli
          # ls -alR ./artifacts
          nix develop -c just package ${{ inputs.target }}

      - name: Upload debian packaged artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: hoprd-${{ inputs.target }}.deb
          path: ${{ github.workspace }}/target/hoprd-${{ inputs.target }}.deb

      - name: Upload rpm packaged artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: hoprd-${{ inputs.target }}.rpm
          path: ${{ github.workspace }}/target/hoprd-${{ inputs.target }}.rpm

      - name: Upload alpine packaged artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: hoprd-${{ inputs.target }}.apk
          path: ${{ github.workspace }}/target/hoprd-${{ inputs.target }}.apk
