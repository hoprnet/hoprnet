---
name: Update flake.lock

on:
  workflow_dispatch: # allows manual triggering
  schedule:
    - cron: '0 0 * * 0' # runs weekly on Sunday at 00:00

permissions:
  contents: read

jobs:
  lockfile:
    runs-on: self-hosted-hoprnet-bigger
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@4d991eb9b905ef189e4c376166672c3f2f230481 # v2.11.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      # # NOTE: not working on self-hosted runners
      # - name: Update flake.lock
      #   uses: DeterminateSystems/update-flake-lock@main
      #   with:
      #     pr-title: "chore(nix): update flake.lock"
      #     pr-labels: |
      #       dependencies
      #       automated

      - name: Install Nix
        uses: cachix/install-nix-action@08dcb3a5e62fa31e2da3d490afc4176ef55ecd72 # v30
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - uses: cachix/cachix-action@ad2ddac53f961de1989924296a1f236fcfbaa4fc # v15
        with:
          name: hoprnet
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
        env:
          USER: runner

      - name: Update the flake.lock
        run: nix flake update

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          token: ${{ secrets.GH_RUNNER_TOKEN }}
          commit-message: "Update flake.lock"
          base: master
          title: "Bump the flake.lock"
          body: "Update the inputs pinned in the flake.lock and used by the flake.nix."
          branch: bot/update/flake-lock
          delete-branch: true
          draft: false
          assignees: ${{ github.actor }}
          team-reviewers: "@hoprnet/hopr-development"

      - name: Enable Auto Merge
        run: |
          git fetch
          git checkout bot/update/flake-lock
          gh pr ready
          gh pr merge --auto --delete-branch --squash
        env:
          GH_TOKEN: ${{ secrets.GH_RUNNER_TOKEN }}
