---
#################################################################################
# Pipeline triggered on pull request merge to check benchmark results 
#################################################################################
name: Bencher

env:
  RUST_BACKTRACE: "1"

on:
  pull_request:
    types:
      - closed
      # - synchronize

concurrency:
  group: ${{ github.ref }}-bencher
  cancel-in-progress: true

jobs:
  bencher:
    name: Bencher
    runs-on: self-hosted-hoprnet-bigger
    timeout-minutes: 30
    if: github.event.pull_request.merged == true
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@4d991eb9b905ef189e4c376166672c3f2f230481 # v2.11.0
        with:
          disable-sudo: true
          egress-policy: audit # TODO: change to 'egress-policy: block' after couple of runs

      - name: Checkout hoprnet repository
        uses: actions/checkout@v4

      - name: Setup Bencher
        uses: bencherdev/bencher@main

      - name: Track base branch benchmarks with Bencher
        run: |
          bencher run \
          --threshold-measure latency \
          --threshold-test t_test \
          --threshold-max-sample-size 64 \
          --threshold-upper-boundary 0.99 \
          --thresholds-reset \
          --err \
          --adapter rust_criterion \
          --github-actions '${{ secrets.GITHUB_TOKEN }}' \
          "cargo bench -F testing"
        env:
            BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}
            BENCHER_BRANCH: ${{ github.event.pull_request.head.ref }}
            BENCHER_PROJECT: hoprnet
            BENCHER_TESTBED: self-hosted-bigger
