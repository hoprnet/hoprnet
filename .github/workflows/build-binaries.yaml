---
#################################################################################
# Child pipeline to build hoprnet binaries
#################################################################################
name: Build binaries

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      runner:
        required: true
        type: string
      package:
        required: true
        type: string
      target:
        required: true
        type: string
      interpreter:
        required: false
        type: string
        default: ''
concurrency:
  group: ${{ github.head_ref }}-build-binary-${{ inputs.target }}
  cancel-in-progress: true
jobs:
  build-binary:
    if: contains(github.event.pull_request.labels.*.name, format('binary:{0}', inputs.target))
    runs-on: ${{ inputs.runner }}
    timeout-minutes: 60
    steps:
      - name: Checkout hoprnet repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - uses: cachix/cachix-action@v14
        with:
          name: hoprnet
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
        env:
          USER: runner

      - name: Build hoprd binary
        run: nix build .#${{ inputs.package }} -L
        env:
          PKG: ${{ inputs.package }}

      - name: Patch hoprd binary
        if: ${{ inputs.interpreter != '' }}
        run: nix shell -p patchelf --command "patchelf --set-interpreter ${{ inputs.interpreter }} ./result/bin/hoprd"

      - name: Upload hoprd binary
        uses: actions/upload-artifact@v4
        with:
          name: hoprd-${{ inputs.target }}
          path: ${{ github.workspace }}/result/bin/hoprd

    # - name: Build hopli binary
    #   if: contains(github.event.pull_request.labels.*.name, 'component:hopli')
    #   run: |
    #     nix build .#hopli-${{ inputs.system }}

    # - name: Upload hopli binary
    #   if: contains(github.event.pull_request.labels.*.name, 'component:hopli')
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: hopli-${{ inputs.system }}
    #     path: ${{ github.workspace }}/result/bin/hopli
