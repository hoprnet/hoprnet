---
#################################################################################
# Child pipeline to build hoprnet binaries
#################################################################################
name: Build binaries

on:
  workflow_call:
    inputs:
      base_branch:
        required: true
        type: string
      system:
        required: true
        type: string
concurrency:
  group: ${{ github.head_ref }}-build-binary-${{ inputs.system }}
  cancel-in-progress: true
jobs:
  build-binary:
    runs-on: self-hosted-hoprnet-big
    timeout-minutes: 60
    steps:
      - name: Checkout hoprnet repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base_branch }}

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - uses: cachix/cachix-action@v14
        with:
          name: hoprnet
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
        env:
          USER: runner

      - name: Determine build options
        id: options
        run: |
          if ${{ contains(github.event.pull_request.labels.*.name, 'release') }}; then
            echo "NIX_PACKAGE_HOPRD=hoprd" >> $GITHUB_OUTPUT
            echo "NIX_PACKAGE_HOPLI=hopli" >> $GITHUB_OUTPUT
          else
            echo "NIX_PACKAGE_HOPRD=hoprd-debug" >> $GITHUB_OUTPUT
            echo "NIX_PACKAGE_HOPLI=hopli-debug" >> $GITHUB_OUTPUT
          fi

      - name: Build ${{ steps.options.outputs.NIX_PACKAGE_HOPRD }} binary
        run: |
          echo nix run .#${{ steps.options.outputs.NIX_PACKAGE_HOPRD }} --crossSystem ${{ inputs.system }}
          mkdir -p result/bin/ && echo "This is hoprd binary for ${{ inputs.system }}" > result/bin/hoprd

      - name: Upload ${{ steps.options.outputs.NIX_PACKAGE_HOPRD }} binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.options.outputs.NIX_PACKAGE_HOPRD }}-${{ inputs.system }}
          path: ${{ github.workspace }}/result/bin/hoprd

      - name: Build ${{ steps.options.outputs.NIX_PACKAGE_HOPLI }} binary
        if: contains(github.event.pull_request.labels.*.name, 'component:hopli')
        run: |
          echo nix run .#${{ steps.options.outputs.NIX_PACKAGE_HOPLI }} --crossSystem ${{ inputs.system }}
          mkdir -p result/bin/ && echo "This is hopli binary for ${{ inputs.system }}" > result/bin/hopli

      - name: Upload ${{ steps.options.outputs.NIX_PACKAGE_HOPLI }} binary
        if: contains(github.event.pull_request.labels.*.name, 'component:hopli')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.options.outputs.NIX_PACKAGE_HOPLI }}-${{ inputs.system }}
          path: ${{ github.workspace }}/result/bin/hopli
