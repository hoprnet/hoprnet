---
name: Create Release

on:
  workflow_call:
    inputs:
      base_branch:
        description: 'The base branch for the pull request'
        required: true
        type: string
      head_branch:
        description: 'The head branch for the pull request'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      head_branch:
        description: 'The head branch from which download artifacts'
        required: true
        type: string

concurrency:
  group: create-release
  cancel-in-progress: false

jobs:
  create_release:
    name: Create Release
    runs-on: ubuntu-latest-4-cores # Cannot use a self-hosted runner because of the docker daemon not running
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          disable-sudo: true
          egress-policy: audit # TODO: change to 'egress-policy: block' after couple of runs

      - name: Set environment variables
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "pull_request_target" ]]; then
            echo "The workflow is triggered by other pipeline"
            echo "base_branch=${{ inputs.base_branch }}"  | tee -a $GITHUB_OUTPUT
            echo "head_branch=${{ inputs.head_branch }}"  | tee -a $GITHUB_OUTPUT
          else
            echo "The workflow is triggered manually"
            echo "base_branch=${{ github.ref_name }}" | tee -a $GITHUB_OUTPUT
            echo "head_branch=${{ github.event.inputs.head_branch }}" | tee -a $GITHUB_OUTPUT
          fi

      - name: Checkout hoprnet repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0 # Required for tagging
          # Using a PAT because this job can be invoked from `pull_request_target`
          token: ${{ secrets.GH_RUNNER_TOKEN }}
          ref: ${{ steps.vars.outputs.base_branch }}

      - name: Setup GCP
        id: gcp
        uses: hoprnet/hopr-workflows/actions/setup-gcp@644d936de4e1c8f5c50ba50f8526209455c28b4a # master
        with:
          google-credentials: ${{ secrets.GOOGLE_HOPRASSOCIATION_CREDENTIALS_REGISTRY }}
          login-artifact-registry: 'true'
          install-sdk: 'true'

      - name: Log in to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Setup workspace
        id: setup
        run: |
          current_version=$(./scripts/get-current-version.sh semver)
          echo "current_version=${current_version}" >> $GITHUB_OUTPUT
          if [[ $current_version == *"-rc."* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi
          ./scripts/download-workflow-binaries.sh ${{ steps.vars.outputs.head_branch }}
        env:
          GH_TOKEN: ${{ secrets.GH_RUNNER_TOKEN }}

      - name: Generate Changelog
        run: |
          ./scripts/generate-changelog.sh ${{ steps.setup.outputs.current_version }} github | tee docs/changelog/changelog.md
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Tag repository
        id: tag
        run: |
          declare base_branch=${{ steps.vars.outputs.base_branch }}
          # Tag release name
          if [[ "${base_branch}" == "master" ]]; then
            release_name=${{ vars.BRANCH_MASTER_RELEASE_NAME }}
          elif [[ "${base_branch}" =~ ^"release" ]]; then
            release_name=${{ vars.BRANCH_RELEASE_RELEASE_NAME }}
          else
            echo "âŒ Unsupported base branch: ${base_branch}" >&2
            exit 1
          fi
          git tag --force "${release_name}"
          git push --force origin "${release_name}"
          echo "release_name=${release_name}" >> $GITHUB_OUTPUT

      - name: Tag docker images with release name
        run: |
          images=(hoprd)
          for image in ${images[@]};
          do
            echo "Tagging ${image}:${{ steps.tag.outputs.release_name }}"
            gcloud artifacts docker tags add \
              "${{ vars.DOCKER_IMAGE_REGISTRY }}/${image}:${{ steps.setup.outputs.current_version }}" \
              "${{ vars.DOCKER_IMAGE_REGISTRY }}/${image}:${{ steps.tag.outputs.release_name }}"
            docker pull "${{ vars.DOCKER_IMAGE_REGISTRY }}/${image}:${{ steps.setup.outputs.current_version }}"
            docker tag \
              "${{ vars.DOCKER_IMAGE_REGISTRY }}/${image}:${{ steps.setup.outputs.current_version }}" \
              "${{ vars.DOCKER_HUB_ORGANIZATION_NAME }}/${image}:${{ steps.setup.outputs.current_version }}"
            docker tag \
              "${{ vars.DOCKER_IMAGE_REGISTRY }}/${image}:${{ steps.setup.outputs.current_version }}" \
              "${{ vars.DOCKER_HUB_ORGANIZATION_NAME }}/${image}:${{ steps.tag.outputs.release_name }}"
            echo "Pushing images into Docker Hub"
            docker push "${{ vars.DOCKER_HUB_ORGANIZATION_NAME }}/${image}:${{ steps.setup.outputs.current_version }}"
            docker push "${{ vars.DOCKER_HUB_ORGANIZATION_NAME }}/${image}:${{ steps.tag.outputs.release_name }}"
          done

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          body_path: docs/changelog/changelog.md
          prerelease: ${{ steps.setup.outputs.prerelease }}
          name: HOPR - v${{ steps.setup.outputs.current_version }}
          tag_name: v${{ steps.setup.outputs.current_version }}
          files: ./dist/upload/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew formula
        uses: peter-evans/repository-dispatch@28959ce8df70de7be546dd1250a005dd32156697 # v4.0.1
        with:
          token: ${{ secrets.GH_RUNNER_TOKEN }}
          repository: hoprnet/homebrew-hoprd
          event-type: create_release
          client-payload: |-
            {
              "base_branch": "${{ steps.vars.outputs.base_branch }}",
              "version": "${{ steps.setup.outputs.current_version }}"
            }

      - name: Close Milestone
        run: |
          milestone_number=$(gh api repos/${{ github.repository }}/milestones | jq -r --arg version "${{ steps.setup.outputs.current_version }}"  ' to_entries[] | select(.value.title | test($version)).value.number')
          gh api --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/milestones/${milestone_number} \
            -f state='closed'
        env:
          GH_TOKEN: ${{ secrets.GH_RUNNER_TOKEN }}

      - name: Notify release
        uses: zulip/github-actions-zulip/send-message@e4c8f27c732ba9bd98ac6be0583096dea82feea5 # v1.0.2
        with:
          api-key: ${{ secrets.ZULIP_API_KEY }}
          email: ${{ secrets.ZULIP_EMAIL }}
          organization-url: "https://hopr.zulipchat.com"
          type: "stream"
          to: "HOPRd"
          topic: "Releases"
          content: |
            I'm thrilled to inform the new hoprd version v${{ steps.setup.outputs.current_version }} has been released.
            [Release Notes](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.setup.outputs.current_version }})
            [Docker Hub](https://hub.docker.com/r/hoprnet/hoprd)

