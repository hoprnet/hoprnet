---
#################################################################################
# Pipeline triggered on every merged pull request to:
# 1. Cleanup the pull request cache
# 2. Update the latest docker tag and the release docker tag if it is part of a release
# 3. Deploy the pull request in rotsee network
# 4. Create the github release with changelog if it is labeled with 'release'. Close the associated milestone.
# 5. Create the new release pull request
#################################################################################
name: Merge

on:
  pull_request:
    types:
      - closed
      # - synchronize

concurrency:
  group: merge
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  cleanup_actions:
    name: Cleanup Actions
    runs-on: self-hosted-hoprnet-small
    steps:
      - name: Checkout hoprnet repository
        uses: actions/checkout@v4
      - name: Cleanup
        run: |
          gh extension install actions/gh-actions-cache

          REPO=${{ github.repository }}
          BRANCH="refs/pull/${{ github.event.pull_request.number }}/merge"

          echo "Fetching list of cache key"
          cacheKeysForPR=$(gh actions-cache list -R $REPO -B $BRANCH | cut -f 1 )

          ## Setting this to not fail the workflow while deleting cache keys.
          set +e
          echo "Deleting caches..."
          for cacheKey in $cacheKeysForPR
          do
            gh actions-cache delete $cacheKey -R $REPO -B $BRANCH --confirm
          done
          echo "Done"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_production_docker:
    strategy:
      matrix:
        package:
          - hopli
          - hoprd
    name: ${{ matrix.package }}
    uses: ./.github/workflows/build-docker.yaml
    with:
      branch: ${{ github.event.pull_request.base.ref }}
      package: ${{ matrix.package }}
      production: true
    secrets: inherit

  tag_images:
    name: Tag images
    runs-on: self-hosted-hoprnet-small
    if: github.event.pull_request.merged == true && (github.event.pull_request.base.ref == 'master' || contains(github.event.pull_request.base.ref,'release/'))
    needs:
      - build_production_docker
    steps:
      - name: Checkout hoprnet repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Google Cloud Credentials
        id: auth
        uses: google-github-actions/auth@v2
        with:
          token_format: "access_token"
          credentials_json: ${{ secrets.GOOGLE_HOPRASSOCIATION_CREDENTIALS_REGISTRY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GOOGLE_HOPRASSOCIATION_PROJECT }}
          install_components: beta

      - name: Login Google Container Registry
        uses: docker/login-action@v3
        with:
          registry: europe-west3-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}

      - name: Tag docker images
        run: |
          docker_registry="europe-west3-docker.pkg.dev/${{ secrets.GOOGLE_HOPRASSOCIATION_PROJECT }}/docker-images"

          # Find docker PR tag
          if ${{ contains(github.event.pull_request.labels.*.name, 'release') }}; then
            docker_pr_tag=$(./scripts/get-current-version.sh docker)
          else
            docker_pr_tag=$(./scripts/get-next-version.sh Build | sed 's/+.*/-pr.'${{ github.event.pull_request.number }}'/')
          fi

          # Find docker release latest tag
          declare base_branch=${{ github.event.pull_request.base.ref }}
          if [ "${base_branch}" == "master" ]; then
            docker_release_latest_tag=${{ vars.BRANCH_MASTER_RELEASE_NAME }}-latest
          else
            docker_release_latest_tag=${base_branch/release\//}-latest
          fi

          # Tag images
          images=(hopli hoprd)
          for image in ${images[@]}; do
            echo "Tagging ${image}:${docker_release_latest_tag}"
            gcloud artifacts docker tags add ${docker_registry}/${image}:${docker_pr_tag} ${docker_registry}/${image}:${docker_release_latest_tag}
            if [ "${base_branch}" == "master" ]; then
              echo "Tagging ${image}:latest"
              gcloud artifacts docker tags add ${docker_registry}/${image}:${docker_pr_tag} ${docker_registry}/${image}:latest
            fi
          done

  deploy_nodes:
    name: Deploy nodes
    runs-on: self-hosted-hoprnet-small
    if: needs.tag_images.result == 'success'
    needs:
      - tag_images
    steps:
      - name: Checkout hoprnet repository
        uses: actions/checkout@v4

      - name: Set up Google Cloud Credentials
        id: auth
        uses: google-github-actions/auth@v2
        with:
          token_format: "access_token"
          credentials_json: ${{ secrets.GCP_SA_TERRAFORM_JSON }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: hopr-staging
          install_components: beta

      - name: Get credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: cluster-staging
          location: europe-west3
          project_id: hopr-staging

      - name: "Restart deployments"
        timeout-minutes: 5
        run: |
          base_branch="${{ github.event.pull_request.base.ref }}"
          # Identify parameters depending on branch
          if [[ "${base_branch}" == "master" ]]; then
            hoprd_cluster=hoprd-core-rotsee
            gh variable set LOAD_TESTING_NETWORK --body "rotsee"
          elif [[ "${base_branch}" =~ ^"release" ]]; then
            hoprd_cluster=hoprd-core-dufour
            gh variable set LOAD_TESTING_NETWORK --body "dufour"
          else
            echo "Skipping deployment"
            exit 0
          fi
          namespace=core-team
          echo "[INFO] Restarting deployments on ${namespace} from pr-${{ github.event.pull_request.number }}"
          kubectl rollout restart deployments -n ${namespace} -l hoprds.hoprnet.org/cluster=${hoprd_cluster};
          kubectl rollout status  deployments -n ${namespace} -l hoprds.hoprnet.org/cluster=${hoprd_cluster};
        env:
          GH_TOKEN: ${{ secrets.GH_RUNNER_TOKEN }}

      - name: "Undeploy PR deployment"
        if: contains(github.event.pull_request.labels.*.name, 'deploy_nodes')
        run: |
          gh pr edit ${{ github.event.pull_request.number }} --remove-label "deploy_nodes"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  load_test:
    name: Load Testing
    if: contains(github.event.pull_request.labels.*.name, 'load_tests')
    needs:
      - deploy_nodes
    uses: ./.github/workflows/load-tests.yaml
    with:
      test_id: pr-${{ github.event.pull_request.number }}
      network: ${{ vars.LOAD_TESTING_NETWORK }}
      workload: one-hop
      duration: ${{ vars.LOAD_TESTING_DURATION }}
      rate: "${{ vars.LOAD_TESTING_RATE }}"
    secrets: inherit

  create_release:
    name: Create Release
    runs-on: ubuntu-latest-4-cores # Cannot use a self-hosted runner because of the docker daemon not running
    if: contains(github.event.pull_request.labels.*.name, 'release')
    needs:
      - tag_images
    steps:
      - name: Checkout hoprnet repository
        uses: actions/checkout@v4

      - name: Set up Google Cloud Credentials
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_HOPRASSOCIATION_CREDENTIALS_REGISTRY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GOOGLE_HOPRASSOCIATION_PROJECT }}
          install_components: beta

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Setup workspace
        id: setup
        run: |
          current_version=$(./scripts/get-current-version.sh semver)
          echo "current_version=${current_version}" >> $GITHUB_OUTPUT
          if [[ $current_version == *"-rc."* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi
          ./scripts/download-workflow-binaries.sh ${{ github.event.pull_request.number }}
        env:
          GH_TOKEN: ${{ secrets.GH_RUNNER_TOKEN }}

      - name: Tag repository
        id: tag
        run: |
          # Tag semver
          git tag v${{ steps.setup.outputs.current_version }}
          git push origin v${{ steps.setup.outputs.current_version }}

          declare base_branch=${{ github.event.pull_request.base.ref }}
          # Tag release name
          if [[ "${base_branch}" == "master" ]]; then
            release_name=${{ vars.BRANCH_MASTER_RELEASE_NAME }}
          elif [[ "${base_branch}" =~ ^"release" ]]; then
            release_name=${{ vars.BRANCH_RELEASE_RELEASE_NAME }}
          fi
          git tag --force ${release_name}
          git push --force origin ${release_name}
          echo "release_name=${release_name}" >> $GITHUB_OUTPUT

      - name: Generate Changelog
        id: changelog
        run: |
          milestone_number=$(gh api repos/${{ github.repository }}/milestones | jq -r --arg version "${{ steps.setup.outputs.current_version }}"  ' to_entries[] | select(.value.title | test($version)).value.number')
          ./scripts/generate-changelog.sh ${milestone_number} | tee docs/changelog/changelog.md
          echo "milestone_number=${milestone_number}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Tag docker images with release name
        run: |
          gcp_docker_registry="europe-west3-docker.pkg.dev/${{ secrets.GOOGLE_HOPRASSOCIATION_PROJECT }}/docker-images"
          images=(hopli hoprd)
          for image in ${images[@]};
          do
            echo "Tagging ${image}:${{ steps.tag.outputs.release_name }}"
            gcloud artifacts docker tags add ${gcp_docker_registry}/${image}:${{ steps.setup.outputs.current_version }} ${gcp_docker_registry}/${image}:${{ steps.tag.outputs.release_name }}
            docker pull ${gcp_docker_registry}/${image}:${{ steps.setup.outputs.current_version }}
            docker tag ${gcp_docker_registry}/${image}:${{ steps.setup.outputs.current_version }} ${{ vars.DOCKER_HUB_ORGANIZATION_NAME }}/${image}:${{ steps.setup.outputs.current_version }}
            docker tag ${gcp_docker_registry}/${image}:${{ steps.setup.outputs.current_version }} ${{ vars.DOCKER_HUB_ORGANIZATION_NAME }}/${image}:${{ steps.tag.outputs.release_name }}
            echo "Pushing images into Docker Hub"
            docker push ${{ vars.DOCKER_HUB_ORGANIZATION_NAME }}/${image}:${{ steps.setup.outputs.current_version }}
            docker push ${{ vars.DOCKER_HUB_ORGANIZATION_NAME }}/${image}:${{ steps.tag.outputs.release_name }}
          done

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: docs/changelog/changelog.md
          prerelease: ${{ steps.setup.outputs.prerelease }}
          name: HOPR - v${{ steps.setup.outputs.current_version }}
          tag_name: v${{ steps.setup.outputs.current_version }}

      - name: Upload release assets
        run: |
          for binary in ./binaries/*; do
            echo "Uploading $binary to release v${{ steps.setup.outputs.current_version }}"
            gh release upload v${{ steps.setup.outputs.current_version }} "$binary" --clobber
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Close Milestone
        run: |
          gh api --method PATCH -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" /repos/${{ github.repository }}/milestones/${{ steps.changelog.outputs.milestone_number }} -f state='closed'
        env:
          GH_TOKEN: ${{ secrets.GH_RUNNER_TOKEN }}

  new_release:
    name: Open new release
    if: contains(github.event.pull_request.labels.*.name, 'release')
    needs:
      - create_release
    uses: ./.github/workflows/open-release.yaml
    with:
      release_type: ${{ vars.NEXT_RELEASE_TYPE }}
      base_branch: ${{ github.event.pull_request.base.ref }}
    secrets: inherit

  build_dappnode:
    name: Build dappNode
    if: contains(github.event.pull_request.labels.*.name, 'release')
    needs:
      - create_release
    uses: ./.github/workflows/generate-dappnode-pr.yaml
    with:
      base_branch: ${{ github.event.pull_request.base.ref }}
    secrets: inherit

  generate_sdk:
    name: Generate SDK
    if: contains(github.event.pull_request.labels.*.name, 'release')
    needs:
      - create_release
    uses: ./.github/workflows/generate-sdk.yaml
    with:
      base_branch: ${{ github.event.pull_request.base.ref }}
    secrets: inherit
