---
#################################################################################
# Pipeline to check pull requests in the hoprnet repository.
#################################################################################
name: Check PR

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

permissions:
  contents: read

concurrency:
  group: ${{ github.ref }}-check-pr
  cancel-in-progress: true

jobs:
  check-pr:
    name: Check PR
    runs-on: self-hosted-hoprnet-small
    permissions:
      contents: read
      # This grants the necessary permissions to manage labels on PRs.
      # PRs are a type of issue.
      issues: write
      pull-requests: write
    steps:
      - name: Checkout hoprnet repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Check PR changeset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE_REPO: ${{ github.repository }}
          HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Check if the PR is from a fork
          if [[ "$HEAD_REPO" != "$BASE_REPO" ]]; then
            echo "PR is from a fork."

            # Fetch the list of changed files
            CHANGED_FILES=$(gh pr view "$PR_NUMBER" --json files --jq '.files[].path')

            # Check if any file in .github is modified
            if echo "$CHANGED_FILES" | grep -q "^.github/"; then
              echo "PR modifies files in .github"
              gh pr edit "$PR_NUMBER" --add-label "external" --add-label "malicious-code"
              exit 1
            fi
          else
            echo "PR is not from a fork."
          fi
