# HOPR Network Development Guidelines

## Project Overview

HOPR is a privacy-preserving messaging protocol implementing secure communication via relay nodes with economic incentives.

**Key Components**:
- [hopr/hopr-lib](hopr/hopr-lib) - Core protocol implementation over libp2p
- [hoprd/hoprd](hoprd/hoprd) - Daemon application with REST API
- Modular crates: `crypto/*`, `transport/*`, `protocols/*`, `db/*`, `chain/*`

## Build & Test (Run These Commands)

### Essential Commands (MUST run before committing)
```bash
nix fmt                    # Format all code (Rust, Nix, Solidity, Python)
nix run -L .#check        # Run clippy + all linters
```

### Build
```bash
nix develop -c cargo build              # Standard build
nix build .#hoprd-candidate             # Fast build (opt-level 2, lto=false)
nix build .#hoprd-docker                # Docker image
cargo build --profile release           # Production (opt-level 3, lto="fat")
```

### Test
```bash
cargo test --lib                        # Unit tests only
cargo test --test '*' -- --test-threads=1   # Integration tests (MUST be single-threaded)
cargo bench                             # Benchmarks (in benches/ dirs)
just run-local-cluster                  # Local multi-node cluster
```

### Setup
1. Install Nix with flakes: `~/.config/nix/nix.conf` → `experimental-features = nix-command flakes`
2. Enable direnv: `direnv allow .` (auto-loads environment + pre-commit hooks)

## Technology Stack

- **Rust**: Tokio async runtime (runtime-agnostic used if possible), libp2p networking
- **Database**: SQLite via SeaORM (entities in [db/entity](db/entity), migrations in [db/migration](db/migration))
- **REST API**: Axum + utoipa (OpenAPI), token auth via `X-Auth-Token` header
- **Blockchain**: Ethereum-compatible via blokli-client
- **Testing**: Rust native tests, pytest (integration), Criterion (benchmarks)

## Architecture

### Workspace Structure (strict dependency layers)
```
crypto/*      - Core primitives, NO dependencies on other HOPR crates
  ├─ keypair  - Dual keys: ChainKeypair (Secp256k1) + OffchainKeypair (Ed25519)
  ├─ packet   - HOPR packet construction
  ├─ sphinx   - Onion routing (X25519Suite, ChaCha20 PRG)
  └─ random   - Secure randomness

chain/*       - Blockchain via blokli-client (account/channel/ticket streams)
transport/*   - libp2p networking, mixer, sessions
protocols/*   - HOPR protocol, application layer, session management
db/*          - SQLite/SeaORM (NEVER manually edit db/entity/* - use sea-orm-cli)
hopr/hopr-lib - Aggregates all components into unified API
hoprd/*       - Daemon + REST API (Axum/utoipa)
```

**Start Here**: [hopr/hopr-lib/src/lib.rs](hopr/hopr-lib/src/lib.rs) → `Hopr` struct, [hoprd/hoprd/src/main.rs](hoprd/hoprd/src/main.rs)

### Key Design Patterns

**Dual-Key System** ([crypto/keypair/src/keystore.rs](crypto/keypair/src/keystore.rs)):
- `chain_key` (Secp256k1) → Ethereum transactions, PeerId: `16Uiu2...`
- `packet_key` (Ed25519) → Packet routing, PeerId: `12D3KooW...`
- Both encrypted in Ethereum KeyStore v3 format (AES-128-CTR + scrypt)

**Async Parallelization** ([common/parallelize](common/parallelize)):
- CPU-bound: `hopr_parallelize::cpu::spawn_blocking()` (rayon pool)
- IO-bound: `tokio::spawn` 
- **NEVER** use `tokio::task::spawn_blocking` for CPU work
- Thread pools: `HOPRD_NUM_CPU_THREADS` / `HOPRD_NUM_IO_THREADS` env vars

**Channels**: Always bounded (see [README.md](README.md#L163) for capacity env vars)

## Code Style

### Critical Rules (see [.github/instructions/rust.instructions.md](.github/instructions/rust.instructions.md))
- Use `tracing::info!()` not `info!()` (explicit prefix required)
- Error handling: `thiserror` for libraries, `anyhow` for applications
- Async locks: `parking_lot::Mutex` (sync), `tokio::sync::Mutex` (async) - NEVER `std::sync::Mutex`
- Naming: `snake_case` functions/vars, `CamelCase` types/traits
- Documentation: `///` for public APIs with examples

### Database
- **Entities**: Auto-generated in `db/entity/` via `sea-orm-cli` - DO NOT EDIT
- **Migrations**: Add to `db/migration/src/`
- **Testing**: Use `HoprNodeDb::new_in_memory()` - see [hopr/hopr-lib/src/testing/](hopr/hopr-lib/src/testing/)

### Configuration
- YAML configs: [sdk/default.cfg.yaml](sdk/default.cfg.yaml), [sdk/barebone.cfg.yaml](sdk/barebone.cfg.yaml)
- Validation: `#[derive(Validate)]` + `validator` crate
- Defaults: `#[derive(SmartDefault)]` from `smart-default`
- Example: [hoprd/hoprd/src/config.rs](hoprd/hoprd/src/config.rs)

## Project-Specific Conventions

### HOPR Protocol
- **Packets**: Use `hopr-crypto-packet` types
- **Routing**: Paths validated with `ValidatedPath` from `hopr-internal-types`
- **Tickets**: Payment channel tickets via `hopr-internal-types::tickets`
- **Sessions**: Session protocol in `protocols/session`
- **SURBs**: Single-Use Reply Blocks for response routing
- **Mixing**: Packet timing obfuscation via mixer in `transport/mixer`

### Networking
- **PeerId**: libp2p identity, derived from `OffchainPublicKey`
- **Multiaddr**: Use libp2p multiaddr format
- **Protocols**: Register custom protocols with libp2p
- **Streams**: Use `libp2p-stream` for bidirectional communication

### Cryptography
- **Keys**: Separate on-chain (`ChainKeypair`) and off-chain (`OffchainKeypair`) keys
- **Sphinx**: Onion encryption via `hopr-crypto-sphinx`
- **Randomness**: Use `hopr-crypto-random` for secure randomness

## Git & Development Workflow

### Commits
- HOPR Protocol Specifics

### Packet Processing ([crypto/packet](crypto/packet))
- **Validation**: Use `ValidatedPath` type BEFORE processing to prevent routing attacks
- **Tickets**: Payment channel tickets via `hopr-internal-types::tickets`
- **SURBs**: Single-Use Reply Blocks for response routing
- **Mixing**: Timing obfuscation in [transport/mixer](transport/mixer)

### Sessions ([protocols/session](protocols/session))
- Entry/Exit node pattern for client connections
- PID controller for SURB balancing: `HOPR_BALANCER_PID_*_GAIN` env vars
- Frame size: `HOPR_SESSION_FRAME_SIZE=1500` (default)
- UDP port range: `HOPRD_SESSION_PORT_RANGE=start:end` syntax

### Blockchain Integration ([chain/connector](chain/connector))
```rust
// Channel operations (see hopr-lib/src/traits/chain.rs)
chain_api.open_channel(peer, amount).await?;
chain_api.close_channel(channel_selector, ...).await?;
chain_api.redeem_tickets_in_channel(channel_selector).await?;
```
**Network Registry**: Production nodes require registration on `HoprNetworkRegistry` contract - see [NETWORK_REGISTRY.md](NETWORK_REGISTRY.md)

### REST API ([hoprd/rest-api](hoprd/rest-api))
- **Auth**: Three methods - `X-Auth-Token` header, `Bearer` token, or `?apiToken=` (WebSocket only)
- **OpenAPI**: Available at `/api-docs/openapi.json`
- **Patterns**: Use `#[utoipa::path]` macros, `#[derive(ToSchema)]` for types
- **Example**: [hoprd/rest-api/src/lib.rs](hoprd/rest-api/src/lib.rs)

## Security-Sensitive Areas

### Key Management ([crypto/keypair/src/keystore.rs](crypto/keypair/src/keystore.rs))
- ⚠️ NEVER log passwords or raw keys
- Scrypt params: Production uses higher `n` than tests (default n=2 is testing only)

### Cryptographic Operations
- All crypto uses `hopr_parallelize::cpu::spawn_blocking()` to avoid blocking tokio
- Example: `OffchainPublicKey::from_peerid()` is blocking - wrap appropriately
- Memory allocators: `allocator-mimalloc` (secure) or `allocator-jemalloc` (profiling)

### API Security
- CORS: Permissive (allows all origins) - see [hoprd/rest-api/src/lib.rs](hoprd/rest-api/src/lib.rs)
- WebSocket limit: `HOPR_INTERNAL_REST_API_MAX_CONCURRENT_WEBSOCKET_COUNT`
- Metrics at `/api/v4/node/metrics` (NO sensitive data by design)

## Common Mistakes (AVOID)

1. ❌ `std::sync::Mutex` in async → ✅ `parking_lot::Mutex` or `tokio::sync::Mutex`
2. ❌ `tokio::task::spawn_blocking` for CPU → ✅ `hopr_parallelize::cpu::spawn_blocking`
3. ❌ Unbounded channels → ✅ Always specify capacity: `channel(N)`
4. ❌ Integration tests in parallel → ✅ Use `-- --test-threads=1` flag
5. ❌ Editing `db/entity/*` manually → ✅ Use `sea-orm-cli` to regenerate
6. ❌ Missing tracing prefix → ✅ `tracing::info!()` not `info!()`
7. ❌ `.unwrap()` in libraries → ✅ Propagate errors with `?`
8. ❌ Compiler warnings → ✅ Fix or `#[allow(reason)]` with justification\
9. ❌ Exposing internal errors in API → ✅ Map to user-friendly messages and don't use errors that make no sense from user perspective
10. ❌ Hardcoding config values → ✅ Use env vars or config files with defaults
11. ❌ For channel operations introduce back-pressure logging or timeouts on inserting into queues → ✅ Implement back-pressure handling and timeouts to avoid long waits or deadlocks

## Key Resources

- [hopr-lib API docs](https://hoprnet.github.io/hoprnet/hopr_lib/)
- Architecture: [docs/design/](docs/design/), [docs/yellowpaper/](docs/yellowpaper/)
- Local cluster: [SETUP_LOCAL_CLUSTER.md](SETUP_LOCAL_CLUSTER.md)
- Metrics: [METRICS.md](METRICS.md)